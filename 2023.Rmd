---
title: '2023'
output: html_document
date: "2025-09-03"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Loading libraries
```{r}
library(janitor)
library(tidyverse)
library(ggthemes)
library(lubridate)
library(lme4)
library(readxl)
library(writexl)
library(sf)
library(MuMIn)
library(scales)
library(sjPlot)
library(rsq)
library(betareg)
library(broom)
library(caret)
library(performance)
library(gam)
library(mgcv)
theme_set(theme_minimal())
```

Loading datasets
```{r}
#Importing summer locations, already joined with veg data and birds online.
summer2023_locs_veg_data <- read_xlsx("/Volumes/Samsung_T5/BOBWHITE_DATA/Clean/SummerLocations/Summer2023/s23rx_no6.xlsx") %>%
  mutate(date = ymd(date)) %>%
  dplyr::filter(status == "A") 

#Importing veg data
veg_data_2023 <- read_xlsx("/Volumes/Samsung_T5/BOBWHITE_DATA/Clean/VegSurveys/VegSurveys2023.xlsx") %>%
  clean_names()

```


#### Determining proportion of birds located in burned areas daily ####
```{r}
# Counting unique birds signaled within a burned area each day
birds_in_burned_areas <- summer2023_locs_veg_data %>%
  dplyr::filter(burned == 1) %>%
  group_by(date) %>%
  summarize(birds_in_burned_areas = n_distinct(band_numb))


# Joining into summer locs data
summer2023_locs_veg_data <- summer2023_locs_veg_data %>%
  left_join(birds_in_burned_areas, by = "date")

# Handling NA values for birds_in_burned_areas
summer2023_locs_veg_data$birds_in_burned_areas[is.na(summer2023_locs_veg_data$birds_in_burned_areas)] <- 0

# Calculate percentage of birds in burned areas
s23rx <- summer2023_locs_veg_data %>%
  mutate(pib = (birds_in_burned_areas / birds_online))

# Handling NA values for pib
s23rx$pib[is.na(s23rx$pib)] <- 0
```



Plot of DSF and PIB, with vertical line at sup feed date.
```{r}
#Changing dsf to DSF
s23rx <- s23rx %>% rename(DSF = dsf)

#Create one row for each day. May need this later.
s23rx_uniq <- s23rx %>% 
  group_by(DSF) %>%
  slice_head(n = 1) %>%
  ungroup()

s23rx_uniq %>%
  ggplot(aes(DSF, pib)) +
  geom_point() +
  geom_vline(xintercept = 77, linetype = "dashed", color = "midnight blue") +
  labs(x = "Days since fire", y = "PIB", title = "2023") +
   theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line("black"),
        axis.ticks = element_line("black"),
        axis.text.x = element_text(colour = "black", size = 12),
        axis.title.y = element_text(colour = "black", size = 12),
        axis.title.x = element_text(colour = "black", size = 12),
        legend.title = element_text(colour = "black", size = 12),
        legend.text = element_text(colour = "black", size = 12),
        axis.text.y = element_text(colour = "black", size = 12),
        plot.margin = margin(t = 5, r = 10, b = 5, l = 5, unit = "pt"))
```


Now lets separate s23rx into "before supplemental feed" and "after supplemental feed". 
Supplemental feed began on June 6th (DSF = 77)
```{r}
#Creating dataframe for "before supplemental feed"
s23rx_pre <- s23rx %>%
  filter(DSF < 77)

s23rx_post <- s23rx %>%
  filter(DSF >= 77)
```


Centering and scaling our vegetation covariates. Selecting relevant columns.
Removing Duplicate Rows, so we only have 1 row per day.
```{r}
#Adding small value to pib so it never = 0. 
s23rx_pre <- s23rx_pre %>% 
  mutate(pib = pib + 0.00001)

#Adding small value to pib so it never = 0. 
s23rx_post <- s23rx_post %>% 
  mutate(pib = pib + 0.00001)

#Selecting relevant columns, pre-sup feed.
s23rx_pre <- s23rx_pre %>%
  dplyr::select(pib, DSF, hg:ps)

#Selecting relevant columns, post-sup feed.
s23rx_post <- s23rx_post %>%
  dplyr::select(pib, DSF, hg:ps)


#Creating only one row per day, pre-sup.
s23rx_pre_uniq <- s23rx_pre %>% 
  group_by(DSF) %>%
  slice_head(n = 1) %>%
  ungroup()

#Creating only one row per day, post-sup.
s23rx_post_uniq <- s23rx_post %>% 
  group_by(DSF) %>%
  slice_head(n = 1) %>%
  ungroup()
```

Checking for correlations in veg data.
```{r}
#Selecting veg, pre-sup feed
pre_veg <- s23rx_pre %>%
  dplyr::select(hg:ps)

#Pre-sup, veg cor
round(cor(pre_veg), 2)

#Selecting veg, pre-sup feed
post_veg <- s23rx_post %>%
  dplyr::select(hg:ps)

#Pre-sup, veg cor
round(cor(post_veg), 2)

veg <- s23rx %>%
  dplyr::select(hg:ps)
```

Plot of use of burned areas in time.
```{r}
#Pre-sup feed
s23rx_pre_uniq %>%
  ggplot(aes(DSF, pib)) +
  geom_point() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line("black"),
        axis.ticks = element_line("black"),
        axis.text.x = element_text(colour = "black", size = 12),
        axis.title.y = element_text(colour = "black", size = 12),
        axis.title.x = element_text(colour = "black", size = 12),
        legend.title = element_text(colour = "black", size = 12),
        legend.text = element_text(colour = "black", size = 12),
        axis.text.y = element_text(colour = "black", size = 12),
        plot.margin = margin(t = 5, r = 10, b = 5, l = 5, unit = "pt")) +
        labs(x = "DSF", y = "PIB")

#Post-sup feed
s23rx_post_uniq %>%
  ggplot(aes(DSF, pib)) +
  geom_point() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line("black"),
        axis.ticks = element_line("black"),
        axis.text.x = element_text(colour = "black", size = 12),
        axis.title.y = element_text(colour = "black", size = 12),
        axis.title.x = element_text(colour = "black", size = 12),
        legend.title = element_text(colour = "black", size = 12),
        legend.text = element_text(colour = "black", size = 12),
        axis.text.y = element_text(colour = "black", size = 12),
        plot.margin = margin(t = 5, r = 10, b = 5, l = 5, unit = "pt")) +
        labs(x = "DSF", y = "PIB")
```

#Pre-sup: Predicting PIB using PF.
```{r}    
# Base model (center line)
pf_model <- betareg(pib ~ pf,
                    data = s23rx_pre_uniq,
                    link = "logit",
                    na.action = na.pass)

# Prediction grid over pf
pf_values <- seq(min(s23rx_pre_uniq$pf, na.rm = TRUE),
                 max(s23rx_pre_uniq$pf, na.rm = TRUE),
                 length.out = 1000)
newdata <- data.frame(pf = pf_values)

# Parametric predictions from the fitted model (for the black line)
predicted_pib <- predict(pf_model, newdata = newdata, type = "response")

# Bootstrap CIs via case-resampling
set.seed(123)
n_boot <- 1000
boot_preds <- matrix(NA_real_, nrow = n_boot, ncol = length(pf_values))

for (i in seq_len(n_boot)) {
  resample_idx  <- sample(nrow(s23rx_pre_uniq), replace = TRUE)
  resample_data <- s23rx_pre_uniq[resample_idx, ]

  # Refit and predict; skip failed fits gracefully
  boot_fit <- tryCatch(
    betareg(pib ~ pf, data = resample_data, link = "logit", na.action = na.pass),
    error = function(e) NULL,
    warning = function(w) invokeRestart("muffleWarning")
  )

  if (!is.null(boot_fit)) {
    boot_preds[i, ] <- tryCatch(
      predict(boot_fit, newdata = newdata, type = "response"),
      error = function(e) rep(NA_real_, nrow(newdata))
    )
  }
}

# 95% percentile CIs
ci_lower <- apply(boot_preds, 2, quantile, probs = 0.025, na.rm = TRUE)
ci_upper <- apply(boot_preds, 2, quantile, probs = 0.975, na.rm = TRUE)

# Attach to newdata
newdata$predicted_pib <- predicted_pib
newdata$ci_lower <- ci_lower
newdata$ci_upper <- ci_upper

# Plot: raw data, prediction line, CI ribbon
ggplot(newdata, aes(x = pf)) +
  geom_point(data = s23rx_pre_uniq, aes(y = pib), size = 2, alpha = 0.7) +
  geom_line(aes(y = predicted_pib), linewidth = 1.2) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2) +
  labs(x = "Percent Forbs",  
       y = "PIB",
       title = "2023: Pre-supplemental period") +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line("black"),
        axis.ticks = element_line("black"),
        axis.text.x = element_text(colour = "black", size = 12),
        axis.title.y = element_text(colour = "black", size = 12),
        axis.title.x = element_text(colour = "black", size = 12),
        legend.title = element_text(colour = "black", size = 12),
        legend.text = element_text(colour = "black", size = 12),
        axis.text.y = element_text(colour = "black", size = 12),
        plot.margin = margin(t = 5, r = 10, b = 5, l = 5, unit = "pt"))

newdata$DSF <- seq(min(s23rx_pre_uniq$DSF, na.rm = TRUE),
                   max(s23rx_pre_uniq$DSF, na.rm = TRUE),
                   length.out = nrow(newdata))

ggplot(newdata, aes(x = DSF)) +
  geom_point(data = s23rx_pre_uniq, aes(x = DSF, y = pib), size = 2, alpha = 0.7) +
  geom_line(aes(y = predicted_pib), linewidth = 1.2) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2) +
  labs(x = "Days since fire", y = "PIB",
       title = "2023: Pre-supplemental period") +
   theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line("black"),
        axis.ticks = element_line("black"),
        axis.text.x = element_text(colour = "black", size = 12),
        axis.title.y = element_text(colour = "black", size = 12),
        axis.title.x = element_text(colour = "black", size = 12),
        legend.title = element_text(colour = "black", size = 12),
        legend.text = element_text(colour = "black", size = 12),
        axis.text.y = element_text(colour = "black", size = 12),
        plot.margin = margin(t = 5, r = 10, b = 5, l = 5, unit = "pt"))

```

#Post-sup: Predicting PIB using PF
```{r}

# Base model (center line) — POST period
pf_model <- betareg(pib ~ pf,
                    data = s23rx_post_uniq,
                    link = "logit",
                    na.action = na.pass)

# Prediction grid over pf (POST)
pf_values <- seq(min(s23rx_post_uniq$pf, na.rm = TRUE),
                 max(s23rx_post_uniq$pf, na.rm = TRUE),
                 length.out = 1000)
newdata <- data.frame(pf = pf_values)

# Parametric predictions from the fitted model (for the black line)
predicted_pib <- predict(pf_model, newdata = newdata, type = "response")

# Bootstrap CIs via case-resampling (POST)
set.seed(123)
n_boot <- 1000
boot_preds <- matrix(NA_real_, nrow = n_boot, ncol = length(pf_values))

for (i in seq_len(n_boot)) {
  resample_idx  <- sample(nrow(s23rx_post_uniq), replace = TRUE)
  resample_data <- s23rx_post_uniq[resample_idx, ]

  # Refit and predict; skip failed fits gracefully
  boot_fit <- tryCatch(
    betareg(pib ~ pf, data = resample_data, link = "logit", na.action = na.pass),
    error = function(e) NULL,
    warning = function(w) invokeRestart("muffleWarning")
  )

  if (!is.null(boot_fit)) {
    boot_preds[i, ] <- tryCatch(
      predict(boot_fit, newdata = newdata, type = "response"),
      error = function(e) rep(NA_real_, nrow(newdata))
    )
  }
}

# 95% percentile CIs
ci_lower <- apply(boot_preds, 2, quantile, probs = 0.025, na.rm = TRUE)
ci_upper <- apply(boot_preds, 2, quantile, probs = 0.975, na.rm = TRUE)

# Attach to newdata
newdata$predicted_pib <- predicted_pib
newdata$ci_lower <- ci_lower
newdata$ci_upper <- ci_upper

# Plot: raw data (POST), prediction line, CI ribbon — x = pf
ggplot(newdata, aes(x = pf)) +
  geom_point(data = s23rx_post_uniq, aes(y = pib), size = 2, alpha = 0.7) +
  geom_line(aes(y = predicted_pib), linewidth = 1.2) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2) +
  labs(x = "Percent Forbs",
       y = "PIB",
       title = "2023: Post-supplemental period") +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line("black"),
        axis.ticks = element_line("black"),
        axis.text.x = element_text(colour = "black", size = 12),
        axis.title.y = element_text(colour = "black", size = 12),
        axis.title.x = element_text(colour = "black", size = 12),
        legend.title = element_text(colour = "black", size = 12),
        legend.text = element_text(colour = "black", size = 12),
        axis.text.y = element_text(colour = "black", size = 12),
        plot.margin = margin(t = 5, r = 10, b = 5, l = 5, unit = "pt"))

#Making data frame to plot DSF on the X axis
newdata$DSF <- seq(min(s23rx_post_uniq$DSF, na.rm = TRUE),
                   max(s23rx_post_uniq$DSF, na.rm = TRUE),
                   length.out = nrow(newdata))

ggplot(newdata, aes(x = DSF)) +
  geom_point(data = s23rx_post_uniq, aes(x = DSF, y = pib), size = 2, alpha = 0.7) +
  geom_line(aes(y = predicted_pib), linewidth = 1.2) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2) +
  labs(x = "Days since fire", y = "PIB",
       title = "2023: Post-supplemental period") +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line("black"),
        axis.ticks = element_line("black"),
        axis.text.x = element_text(colour = "black", size = 12),
        axis.title.y = element_text(colour = "black", size = 12),
        axis.title.x = element_text(colour = "black", size = 12),
        legend.title = element_text(colour = "black", size = 12),
        legend.text = element_text(colour = "black", size = 12),
        axis.text.y = element_text(colour = "black", size = 12),
        plot.margin = margin(t = 5, r = 10, b = 5, l = 5, unit = "pt"))
```

Now lets look at rainfall 2023
```{r}
#Importing weather data
weather <- read_xlsx("/Users/grayum.jeffrey/Downloads/Crafton_rainfall_2023 .xlsx") %>%
  clean_names()

#Selecting relevant columns
rain <- weather %>%
  select(date, rain_total_mm)

#Fixing date column
rain <- rain %>%
  mutate(date = ymd(date))

#Setting burn date
burn_date <- ymd("2023-03-21")

#Creating dsf
rain <- weather %>%
  select(date, rain_total_mm) %>%
  mutate(date = ymd(date),
         dsf = as.integer(date - burn_date))

rain %>%
  ggplot(aes(dsf, rain_total_mm)) +
  geom_point() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line("black"),
        axis.ticks = element_line("black"),
        axis.text.x = element_text(colour = "black", size = 12),
        axis.title.y = element_text(colour = "black", size = 12),
        axis.title.x = element_text(colour = "black", size = 12),
        legend.title = element_text(colour = "black", size = 12),
        legend.text = element_text(colour = "black", size = 12),
        axis.text.y = element_text(colour = "black", size = 12),
        plot.margin = margin(t = 5, r = 10, b = 5, l = 5, unit = "pt")) +
  labs(x = "DSF", y = "Rain total (mm)", title = "2022")

#Plot of 
rain %>%
  arrange(date) %>%
  mutate(cum_rain = cumsum(rain_total_mm)) %>%
  ggplot(aes(x = date, y = cum_rain)) +
  geom_line(color = "darkblue", linewidth = 1.2) +
  labs(x = "Date", y = "Cumulative rainfall (mm)", 
       title = "2023") +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line("black"),
        axis.ticks = element_line("black"),
        axis.text.x = element_text(colour = "black", size = 12),
        axis.title.y = element_text(colour = "black", size = 12),
        axis.title.x = element_text(colour = "black", size = 12),
        legend.title = element_text(colour = "black", size = 12),
        legend.text = element_text(colour = "black", size = 12),
        axis.text.y = element_text(colour = "black", size = 12),
        plot.margin = margin(t = 5, r = 10, b = 5, l = 5, unit = "pt"))

rain %>%
  arrange(dsf) %>%
  mutate(cum_rain = cumsum(rain_total_mm)) %>%
  ggplot(aes(x = dsf, y = cum_rain)) +
  geom_line(color = "darkblue", linewidth = 1.2) +
  labs(x = "Days since fire", 
       y = "Cumulative rainfall (mm)", 
       title = "2023") +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line("black"),
        axis.ticks = element_line("black"),
        axis.text.x = element_text(colour = "black", size = 12),
        axis.title.y = element_text(colour = "black", size = 12),
        axis.title.x = element_text(colour = "black", size = 12),
        legend.title = element_text(colour = "black", size = 12),
        legend.text = element_text(colour = "black", size = 12),
        axis.text.y = element_text(colour = "black", size = 12),
        plot.margin = margin(t = 5, r = 10, b = 5, l = 5, unit = "pt"))
```

Now lets compare rainfall in 2022 vs 2023
```{r}

## ---- 2022 ----
#Importing weather data
weather_22 <- read_xlsx("/Users/grayum.jeffrey/Downloads/Crafton_rainfall_2022 .xlsx") %>%
  clean_names() %>%
  mutate(year = 2022)

#Selecting relevant columns
rain_22 <- weather_22 %>%
  select(date, rain_total_mm, year)

#Fixing date column
rain_22 <- rain_22 %>%
  mutate(date = ymd(date))

#Setting burn date
burn_date_22 <- ymd("2022-04-11")

#Creating dsf
rain_22 <- weather_22 %>%
  select(date, rain_total_mm, year) %>%
  mutate(date = ymd(date),
         dsf  = as.integer(date - burn_date_22))

## ---- 2023 ----
#Importing weather data
weather_23 <- read_xlsx("/Users/grayum.jeffrey/Downloads/Crafton_rainfall_2023 .xlsx") %>%
  clean_names() %>%
  mutate(year = 2023)

#Selecting relevant columns
rain_23 <- weather_23 %>%
  select(date, rain_total_mm, year)

#Fixing date column
rain_23 <- rain_23 %>%
  mutate(date = ymd(date))

#Setting burn date
burn_date_23 <- ymd("2023-03-21")

#Creating dsf
rain_23 <- weather_23 %>%
  select(date, rain_total_mm, year) %>%
  mutate(date = ymd(date),
         dsf  = as.integer(date - burn_date_23))

## ---- Combine years ----
rain <- bind_rows(rain_22, rain_23)

## ---- Facet-wrapped: daily rainfall vs DSF ----
rain %>%
  ggplot(aes(dsf, rain_total_mm)) +
  geom_point() +
  facet_wrap(~ year, ncol = 1) +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line("black"),
        axis.ticks = element_line("black"),
        axis.text.x = element_text(colour = "black", size = 12),
        axis.title.y = element_text(colour = "black", size = 12),
        axis.title.x = element_text(colour = "black", size = 12),
        legend.title = element_text(colour = "black", size = 12),
        legend.text = element_text(colour = "black", size = 12),
        axis.text.y = element_text(colour = "black", size = 12),
        plot.margin = margin(t = 5, r = 10, b = 5, l = 5, unit = "pt")) +
  labs(x = "DSF", y = "Rain total (mm)", title = "Daily rainfall by DSF (2022 vs 2023)")

## ---- Facet-wrapped: cumulative rainfall vs DSF ----
rain %>%
  arrange(year, dsf) %>%
  group_by(year) %>%
  mutate(cum_rain = cumsum(replace_na(rain_total_mm, 0))) %>%
  ungroup() %>%
  ggplot(aes(x = dsf, y = cum_rain)) +
  geom_line(color = "darkblue", linewidth = 1.2) +
  facet_wrap(~ year, ncol = 2) +
  labs(x = "Days since fire",
       y = "Cumulative rainfall (mm)",
       title = "Cumulative rainfall") +
  theme_bw() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line("black"),
        axis.ticks = element_line("black"),
        axis.text.x = element_text(colour = "black", size = 12),
        axis.title.y = element_text(colour = "black", size = 12),
        axis.title.x = element_text(colour = "black", size = 12),
        legend.title = element_text(colour = "black", size = 12),
        legend.text = element_text(colour = "black", size = 12),
        axis.text.y = element_text(colour = "black", size = 12),
        plot.margin = margin(t = 5, r = 10, b = 5, l = 5, unit = "pt"))

rain %>%
  arrange(year, dsf) %>%
  group_by(year) %>%
  mutate(cum_rain = cumsum(replace_na(rain_total_mm, 0))) %>%
  ungroup() %>%
  ggplot(aes(x = dsf, y = cum_rain, color = factor(year), group = year)) +
  geom_line(linewidth = 1.2) +
  labs(x = "Days since fire",
       y = "Cumulative rainfall (mm)",
       color = "Year") +
  scale_x_continuous(limits = c(0, 150), expand = c(0,0)) +  # extend x-axis to 150
  theme_minimal() +
  theme(
    legend.position = "right",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line("black"),
    axis.ticks = element_line("black"),
    axis.text.x = element_text(colour = "black", size = 12),
    axis.title.y = element_text(colour = "black", size = 12),
    axis.title.x = element_text(colour = "black", size = 12),
    legend.title = element_text(colour = "black", size = 12),
    legend.text = element_text(colour = "black", size = 12),
    axis.text.y = element_text(colour = "black", size = 12),
    plot.margin = margin(t = 5, r = 10, b = 5, l = 5, unit = "pt")
  )


```


#### CHAT GPT VERSION ####
```{r}

#### Loading datasets ####
#Importing summer locations, already joined with veg data and birds online.
summer2023_locs_veg_data <- read_xlsx("/Volumes/Samsung_T5/BOBWHITE_DATA/Clean/SummerLocations/Summer2023/s23rx_no6.xlsx") %>%
  mutate(date = ymd(date)) %>%
  dplyr::filter(status == "A") 

#Importing veg data
veg_data_2023 <- read_xlsx("/Volumes/Samsung_T5/BOBWHITE_DATA/Clean/VegSurveys/VegSurveys2023.xlsx") %>%
  clean_names()


#### Determining proportion of birds located in burned areas daily ####
# Counting unique birds signaled within a burned area each day
birds_in_burned_areas <- summer2023_locs_veg_data %>%
  dplyr::filter(burned == 1) %>%
  group_by(date) %>%
  summarize(birds_in_burned_areas = n_distinct(band_numb))

# Joining into summer locs data
summer2023_locs_veg_data <- summer2023_locs_veg_data %>%
  left_join(birds_in_burned_areas, by = "date")

# Handling NA values for birds_in_burned_areas
summer2023_locs_veg_data$birds_in_burned_areas[
  is.na(summer2023_locs_veg_data$birds_in_burned_areas)
] <- 0

# Calculate proportion of birds in burned areas
s23rx <- summer2023_locs_veg_data %>%
  mutate(pib = (birds_in_burned_areas / birds_online))

# Handling NA values for pib
s23rx$pib[is.na(s23rx$pib)] <- 0


#### Plot of DSF and PIB, with vertical line at sup feed date. ####
#Changing dsf to DSF
s23rx <- s23rx %>% rename(DSF = dsf)

#Create one row for each day. May need this later.
s23rx_uniq <- s23rx %>% 
  group_by(DSF) %>%
  slice_head(n = 1) %>%
  ungroup()

s23rx_uniq %>%
  ggplot(aes(DSF, pib)) +
  geom_point() +
  geom_vline(xintercept = 77, linetype = "dashed", color = "midnight blue") +
  labs(x = "Days since fire", y = "PIB", title = "2023") +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line("black"),
        axis.ticks = element_line("black"),
        axis.text.x = element_text(colour = "black", size = 12),
        axis.title.y = element_text(colour = "black", size = 12),
        axis.title.x = element_text(colour = "black", size = 12),
        legend.title = element_text(colour = "black", size = 12),
        legend.text = element_text(colour = "black", size = 12),
        axis.text.y = element_text(colour = "black", size = 12),
        plot.margin = margin(t = 5, r = 10, b = 5, l = 5, unit = "pt"))


#### Now lets separate s23rx into "before supplemental feed" and "after supplemental feed". ####
#### Supplemental feed began on June 6th (DSF = 77) ####
#Creating dataframe for "before supplemental feed"
s23rx_pre <- s23rx %>%
  filter(DSF < 77)

s23rx_post <- s23rx %>%
  filter(DSF >= 77)


#### Centering and scaling our vegetation covariates. Selecting relevant columns. ####
#### Removing Duplicate Rows, so we only have 1 row per day. ####
#Adding small value to pib so it never = 0. 
s23rx_pre <- s23rx_pre %>% 
  mutate(pib = pib + 0.00001)

#Adding small value to pib so it never = 0. 
s23rx_post <- s23rx_post %>% 
  mutate(pib = pib + 0.00001)

#Selecting relevant columns, pre-sup feed.
s23rx_pre <- s23rx_pre %>%
  dplyr::select(pib, DSF, hg:ps)

#Selecting relevant columns, post-sup feed.
s23rx_post <- s23rx_post %>%
  dplyr::select(pib, DSF, hg:ps)

#Creating only one row per day, pre-sup.
s23rx_pre_uniq <- s23rx_pre %>% 
  group_by(DSF) %>%
  slice_head(n = 1) %>%
  ungroup()

#Creating only one row per day, post-sup.
s23rx_post_uniq <- s23rx_post %>% 
  group_by(DSF) %>%
  slice_head(n = 1) %>%
  ungroup()


#### Checking for correlations in veg data. ####
#### Checking for correlations in veg data: 2023 ####

# Selecting veg, pre-sup feed
veg23 <- s23rx_uniq %>%
  dplyr::select(hg:ps)

# Correlation matrix (rounded) – default 'use = "everything"'
veg_cor23 <- veg23 %>%
  cor() %>%
  round(2)

# Convert to data frame and keep row names
veg_cor23_df <- veg_cor23 %>%
  as.data.frame() %>%
  tibble::rownames_to_column(var = "variable")

# Write to Excel
write_xlsx(
  veg_cor23_df,
  "/Volumes/Samsung_T5/FIRE_NOBO_MANUSCRIPT/veg_cor23.xlsx"
)


#Selecting veg, post-sup feed
post_veg <- s23rx_post %>%
  dplyr::select(hg:ps)

#Post-sup, veg cor
round(cor(post_veg), 2)


#### Plot of use of burned areas in time. ####
#Pre-sup feed
s23rx_pre_uniq %>%
  ggplot(aes(DSF, pib)) +
  geom_point() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line("black"),
        axis.ticks = element_line("black"),
        axis.text.x = element_text(colour = "black", size = 12),
        axis.title.y = element_text(colour = "black", size = 12),
        axis.title.x = element_text(colour = "black", size = 12),
        legend.title = element_text(colour = "black", size = 12),
        legend.text = element_text(colour = "black", size = 12),
        axis.text.y = element_text(colour = "black", size = 12),
        plot.margin = margin(t = 5, r = 10, b = 5, l = 5, unit = "pt")) +
  labs(x = "DSF", y = "PIB")

#Post-sup feed
s23rx_post_uniq %>%
  ggplot(aes(DSF, pib)) +
  geom_point() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line("black"),
        axis.ticks = element_line("black"),
        axis.text.x = element_text(colour = "black", size = 12),
        axis.title.y = element_text(colour = "black", size = 12),
        axis.title.x = element_text(colour = "black", size = 12),
        legend.title = element_text(colour = "black", size = 12),
        legend.text = element_text(colour = "black", size = 12),
        axis.text.y = element_text(colour = "black", size = 12),
        plot.margin = margin(t = 5, r = 10, b = 5, l = 5, unit = "pt")) +
  labs(x = "DSF", y = "PIB")


#### Pre-sup: Predicting PIB using PS. ####
# Ensure PIB is strictly within (0, 1) for beta regression
s23rx_pre_uniq <- s23rx_pre_uniq %>%
  mutate(pib = pmin(pmax(pib, 1e-5), 1 - 1e-5))

# Base model (center line)
ps_model <- betareg(pib ~ ps,
                    data = s23rx_pre_uniq,
                    link = "logit",
                    na.action = na.pass)

summary(ps_model)

# Prediction grid over ps
ps_values <- seq(min(s23rx_pre_uniq$ps, na.rm = TRUE),
                 max(s23rx_pre_uniq$ps, na.rm = TRUE),
                 length.out = 1000)
newdata <- data.frame(ps = ps_values)

# Parametric predictions from the fitted model (for the black line)
predicted_pib <- predict(ps_model, newdata = newdata, type = "response")

# Bootstrap CIs via case-resampling
set.seed(123)
n_boot <- 1000
boot_preds <- matrix(NA_real_, nrow = n_boot, ncol = length(ps_values))

for (i in seq_len(n_boot)) {
  resample_idx  <- sample(nrow(s23rx_pre_uniq), replace = TRUE)
  resample_data <- s23rx_pre_uniq[resample_idx, ]

  # Refit and predict; skip failed fits gracefully
  boot_fit <- tryCatch(
    betareg(pib ~ ps, data = resample_data, link = "logit", na.action = na.pass),
    error = function(e) NULL,
    warning = function(w) invokeRestart("muffleWarning")
  )

  if (!is.null(boot_fit)) {
    boot_preds[i, ] <- tryCatch(
      predict(boot_fit, newdata = newdata, type = "response"),
      error = function(e) rep(NA_real_, nrow(newdata))
    )
  }
}

# 95% percentile CIs
ci_lower <- apply(boot_preds, 2, quantile, probs = 0.025, na.rm = TRUE)
ci_upper <- apply(boot_preds, 2, quantile, probs = 0.975, na.rm = TRUE)

# Attach to newdata
newdata$predicted_pib <- predicted_pib
newdata$ci_lower      <- ci_lower
newdata$ci_upper      <- ci_upper

# Plot: prediction line, CI ribbon (no points)
ggplot(newdata, aes(x = ps)) +
  geom_line(aes(y = predicted_pib), linewidth = 1.2) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2) +
  labs(x = "Percent shrubs",  
       y = "PIB",
       title = "2023: Pre-supplemental period") +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line("black"),
        axis.ticks = element_line("black"),
        axis.text.x = element_text(colour = "black", size = 12),
        axis.title.y = element_text(colour = "black", size = 12),
        axis.title.x = element_text(colour = "black", size = 12),
        legend.title = element_text(colour = "black", size = 12),
        legend.text = element_text(colour = "black", size = 12),
        axis.text.y = element_text(colour = "black", size = 12),
        plot.margin = margin(t = 5, r = 10, b = 5, l = 5, unit = "pt"))

# DSF sequence for cosmetic x-axis relabel using same predicted_pib
newdata$DSF <- seq(min(s23rx_pre_uniq$DSF, na.rm = TRUE),
                   max(s23rx_pre_uniq$DSF, na.rm = TRUE),
                   length.out = nrow(newdata))

ggplot(newdata, aes(x = DSF)) +
  geom_line(aes(y = predicted_pib), linewidth = 1.2) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2) +
  labs(x = "Days since fire", y = "PIB",
       title = "2023: Pre-supplemental period") +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line("black"),
        axis.ticks = element_line("black"),
        axis.text.x = element_text(colour = "black", size = 12),
        axis.title.y = element_text(colour = "black", size = 12),
        axis.title.x = element_text(colour = "black", size = 12),
        legend.title = element_text(colour = "black", size = 12),
        legend.text = element_text(colour = "black", size = 12),
        axis.text.y = element_text(colour = "black", size = 12),
        plot.margin = margin(t = 5, r = 10, b = 5, l = 5, unit = "pt"))


#### Post-sup: Predicting PIB using PS ####
# Ensure PIB is strictly within (0, 1) for beta regression
s23rx_post_uniq <- s23rx_post_uniq %>%
  mutate(pib = pmin(pmax(pib, 1e-5), 1 - 1e-5))

# Base model (center line) — POST period
ps_model <- betareg(pib ~ ps,
                    data = s23rx_post_uniq,
                    link = "logit",
                    na.action = na.pass)

summary(ps_model)

# Prediction grid over ps (POST)
ps_values <- seq(min(s23rx_post_uniq$ps, na.rm = TRUE),
                 max(s23rx_post_uniq$ps, na.rm = TRUE),
                 length.out = 1000)
newdata <- data.frame(ps = ps_values)

# Parametric predictions from the fitted model (for the black line)
predicted_pib <- predict(ps_model, newdata = newdata, type = "response")

# Bootstrap CIs via case-resampling (POST)
set.seed(123)
n_boot <- 1000
boot_preds <- matrix(NA_real_, nrow = n_boot, ncol = length(ps_values))

for (i in seq_len(n_boot)) {
  resample_idx  <- sample(nrow(s23rx_post_uniq), replace = TRUE)
  resample_data <- s23rx_post_uniq[resample_idx, ]

  # Refit and predict; skip failed fits gracefully
  boot_fit <- tryCatch(
    betareg(pib ~ ps, data = resample_data, link = "logit", na.action = na.pass),
    error = function(e) NULL,
    warning = function(w) invokeRestart("muffleWarning")
  )

  if (!is.null(boot_fit)) {
    boot_preds[i, ] <- tryCatch(
      predict(boot_fit, newdata = newdata, type = "response"),
      error = function(e) rep(NA_real_, nrow(newdata))
    )
  }
}

# 95% percentile CIs
ci_lower <- apply(boot_preds, 2, quantile, probs = 0.025, na.rm = TRUE)
ci_upper <- apply(boot_preds, 2, quantile, probs = 0.975, na.rm = TRUE)

# Attach to newdata
newdata$predicted_pib <- predicted_pib
newdata$ci_lower      <- ci_lower
newdata$ci_upper      <- ci_upper

# Plot: prediction line, CI ribbon — x = ps (no points)
ggplot(newdata, aes(x = ps)) +
  geom_line(aes(y = predicted_pib), linewidth = 1.2) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2) +
  labs(x = "Percent shrubs",
       y = "PIB",
       title = "2023: Post-supplemental period") +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line("black"),
        axis.ticks = element_line("black"),
        axis.text.x = element_text(colour = "black", size = 12),
        axis.title.y = element_text(colour = "black", size = 12),
        axis.title.x = element_text(colour = "black", size = 12),
        legend.title = element_text(colour = "black", size = 12),
        legend.text = element_text(colour = "black", size = 12),
        axis.text.y = element_text(colour = "black", size = 12),
        plot.margin = margin(t = 5, r = 10, b = 5, l = 5, unit = "pt"))

#Making data frame to plot DSF on the X axis (no points)
newdata$DSF <- seq(min(s23rx_post_uniq$DSF, na.rm = TRUE),
                   max(s23rx_post_uniq$DSF, na.rm = TRUE),
                   length.out = nrow(newdata))

ggplot(newdata, aes(x = DSF)) +
  geom_line(aes(y = predicted_pib), linewidth = 1.2) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2) +
  labs(x = "Days since fire", y = "PIB",
       title = "2023: Post-supplemental period") +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line("black"),
        axis.ticks = element_line("black"),
        axis.text.x = element_text(colour = "black", size = 12),
        axis.title.y = element_text(colour = "black", size = 12),
        axis.title.x = element_text(colour = "black", size = 12),
        legend.title = element_text(colour = "black", size = 12),
        legend.text = element_text(colour = "black", size = 12),
        axis.text.y = element_text(colour = "black", size = 12),
        plot.margin = margin(t = 5, r = 10, b = 5, l = 5, unit = "pt"))


#### Rainfall 2023 ####
#Importing weather data
weather <- read_xlsx("/Users/grayum.jeffrey/Downloads/Crafton_rainfall_2023 .xlsx") %>%
  clean_names()

#Selecting relevant columns
rain <- weather %>%
  select(date, rain_total_mm)

#Fixing date column
rain <- rain %>%
  mutate(date = ymd(date))

#Setting burn date
burn_date <- ymd("2023-03-21")

#Creating dsf
rain <- weather %>%
  select(date, rain_total_mm) %>%
  mutate(date = ymd(date),
         dsf = as.integer(date - burn_date))

rain %>%
  ggplot(aes(dsf, rain_total_mm)) +
  geom_point() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line("black"),
        axis.ticks = element_line("black"),
        axis.text.x = element_text(colour = "black", size = 12),
        axis.title.y = element_text(colour = "black", size = 12),
        axis.title.x = element_text(colour = "black", size = 12),
        legend.title = element_text(colour = "black", size = 12),
        legend.text = element_text(colour = "black", size = 12),
        axis.text.y = element_text(colour = "black", size = 12),
        plot.margin = margin(t = 5, r = 10, b = 5, l = 5, unit = "pt")) +
  labs(x = "DSF", y = "Rain total (mm)", title = "2022")

#Plot of cumulative rainfall (date)
rain %>%
  arrange(date) %>%
  mutate(cum_rain = cumsum(rain_total_mm)) %>%
  ggplot(aes(x = date, y = cum_rain)) +
  geom_line(color = "darkblue", linewidth = 1.2) +
  labs(x = "Date", y = "Cumulative rainfall (mm)", 
       title = "2023") +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line("black"),
        axis.ticks = element_line("black"),
        axis.text.x = element_text(colour = "black", size = 12),
        axis.title.y = element_text(colour = "black", size = 12),
        axis.title.x = element_text(colour = "black", size = 12),
        legend.title = element_text(colour = "black", size = 12),
        legend.text = element_text(colour = "black", size = 12),
        axis.text.y = element_text(colour = "black", size = 12),
        plot.margin = margin(t = 5, r = 10, b = 5, l = 5, unit = "pt"))

#Plot of cumulative rainfall (DSF)
rain %>%
  arrange(dsf) %>%
  mutate(cum_rain = cumsum(rain_total_mm)) %>%
  ggplot(aes(x = dsf, y = cum_rain)) +
  geom_line(color = "darkblue", linewidth = 1.2) +
  labs(x = "Days since fire", 
       y = "Cumulative rainfall (mm)", 
       title = "2023") +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line("black"),
        axis.ticks = element_line("black"),
        axis.text.x = element_text(colour = "black", size = 12),
        axis.title.y = element_text(colour = "black", size = 12),
        axis.title.x = element_text(colour = "black", size = 12),
        legend.title = element_text(colour = "black", size = 12),
        legend.text = element_text(colour = "black", size = 12),
        axis.text.y = element_text(colour = "black", size = 12),
        plot.margin = margin(t = 5, r = 10, b = 5, l = 5, unit = "pt"))

#LOOCV
beta_loocv <- function(data) {
  
  n <- nrow(data)
  preds <- numeric(n)
  
  for (i in 1:n) {
    train <- data[-i, ]
    test  <- data[i, , drop = FALSE]
    
    fit <- betareg(pib ~ ps, data = train, link = "logit")
    preds[i] <- predict(fit, newdata = test, type = "response")
  }
  
  # Combine predictions + observed
  data$pred <- preds
  
  # Calculate performance metrics
  rmse <- sqrt(mean((data$pib - data$pred)^2))
  cor_obs_pred <- cor(data$pib, data$pred)
  
  list(
    rmse = rmse,
    cor_obs_pred = cor_obs_pred,
    results = data
  )
}

#### 2023 LOOCV ####

# 2023 pre-supplemental
loocv_23_pre  <- beta_loocv(s23rx_pre_uniq)
loocv_23_pre$rmse
loocv_23_pre$cor_obs_pred

# 2023 post-supplemental
loocv_23_post <- beta_loocv(s23rx_post_uniq)
loocv_23_post$rmse
loocv_23_post$cor_obs_pred

#### WAS SUP FEED SIG? ####
#### 2023 Pre/Post Combined Dataset ####
combined23 <- bind_rows(
  s23rx_pre_uniq  %>% mutate(feed = 0),
  s23rx_post_uniq %>% mutate(feed = 1)
)

#### Beta regression including ps × feed interaction ####
m23 <- betareg(pib ~ ps * feed, data = combined23, link = "logit")
summary(m23)




```
